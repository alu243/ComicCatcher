@{
    ViewBag.Title = "Favorites";
    Layout = "_Layout";
}

<div id="app" v-cloak>
    <div style="padding:10px 0px;display: flex">
        <button class="btn btn-outline-primary" @@click="goto('?filter=notreaded')" :disabled="queryString == '?filter=notreaded'">未讀</button>
        &nbsp;
        <button class="btn btn-outline-primary" @@click="goto('')" :disabled="queryString == ''">預設</button>
        &nbsp;&nbsp;
        <button class="btn btn-outline-success" @@click="goto('/page/1')">到分頁區</button>
    </div>

    <div v-if="loading" class="loader-background">
        <div class="loader"></div>
    </div>

    <div class="row row-cols-3 row-cols-sm-4 row-cols-md-5 row-cols-lg-6 gx-0">
        <div class="col gx-1" v-for="comic in state.comics">
            <div class="card">
                <div class="g-0 comic-info">
                    <a :href="getComicAction(comic)">
                        <img style="width:100%" :src="comic.iconUrl" />
                    </a>
                </div>
                <div class="card-body g-1" style="padding:3px">
                    <a :href="getComicAction(comic)">
                        <p :class="{'card-title': true, 'text-primary': comic.isFavorite ,'fw-bold': comic.isFavorite, 'lh-sm':true }" style="font-size:14px;padding-top:3px">{{comic.caption}}</p>
                    </a>
                    <span class="card-text lh-sm center" style="font-size:14px; color:darkgray">{{comic.lastUpdateDate}}</span>
                    <span class="card-text lh-sm center" style="font-size:14px; color:darkgray">>{{comic.readedChapter}}{{comic.readedChapter?'/':''}}{{comic.lastUpdateChapter}}<</span>
                </div>
            </div>
        </div>
    </div>

    <br />
    <br />
</div>


@section Scripts {
    <script type="text/javascript">
        const { createApp, onMounted, onBeforeUnmount, reactive, ref } = Vue;
        const app = createApp({
            setup() {
                const state = reactive({
                    comics: null,
                });
                const loading = ref(true);

                const queryString = ref(window.location.search);

                const pathArray = window.location.pathname.split('/');
                const page = pathArray[pathArray.length - 1];

                onMounted(async () => {
                    await loadFavorites();
                    //setTimeout(() => { window.scrollTo(0, 1); }, 1500);
                });

                async function loadFavorites() {
                    let level = "";
                    if (page != 'favorite') {
                        level = `/${page}`
                    }

                    const response = await fetch(`/api/favoritecomic${level}${queryString.value}`);
                    const favoriteComics = await response.json();
                    state.comics = favoriteComics?.comics;

                    addCookie("currentPage", "favorite");

                    setTimeout(() => loading.value = false, 100);
                }

                function getComic(url) {
                    url = url.trim().replace(/\/$/g, '');
                    const pathArray = url.split('/');
                    const comic = pathArray[pathArray.length - 1];
                    return comic;
                }

                function getComicAction(comic) {
                    const c = getComic(comic.url);
                    return `../comic/${c}`;
                }

                function goto(url) {
                    if (url) {
                        location.href = url;
                    } else {
                        location.href = location.toString().replace(location.search, url);
                    }
                }

                return {
                    goto,
                    state,
                    loading,
                    queryString,
                    getComicAction
                }
            }
        });
        app.mount('#app');
        console.log("start app", app);
    </script>
}